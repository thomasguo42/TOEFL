{% extends "base.html" %}

{% block title %}Dictation Challenge - TOEFL Vocabulary Studio{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="mb-0"><i class="fas fa-volume-up me-2 text-info"></i>Dictation Challenge</h2>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    <i class="fas fa-sync-alt me-1"></i> New Words
                </button>
            </div>
            <p class="text-muted mb-0">
                Listen carefully and type what you hear. Audio is generated on demand—feel free to replay. Click "New Words" for different vocabulary.
            </p>
        </div>

        {% for item in exercises %}
        <div class="card mb-4 p-4" data-word="{{ item.lemma | lower }}">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <h5 class="mb-1 text-uppercase text-muted" style="letter-spacing: 0.15em;">Prompt {{ loop.index }}</h5>
                    {% if item.pitfall %}
                    <small class="text-warning"><i class="fas fa-lightbulb me-1"></i>{{ item.pitfall }}</small>
                    {% endif %}
                </div>
                <div>
                    <button class="btn btn-outline-light btn-sm" type="button" onclick="playAudio('{{ loop.index0 }}')">
                        <i class="fas fa-play me-2"></i>Play
                    </button>
                    <button class="btn btn-outline-light btn-sm" type="button" onclick="slowPlay('{{ loop.index0 }}')">
                        <i class="fas fa-hourglass-half me-2"></i>Slow
                    </button>
                </div>
            </div>
            <audio id="audio-{{ loop.index0 }}" src="{{ item.audio_url }}" preload="auto"></audio>

            <div class="mt-3">
                <label for="response-{{ loop.index0 }}" class="form-label text-muted">Type the word you heard</label>
                <input type="text" id="response-{{ loop.index0 }}" class="form-control form-control-lg" autocomplete="off" placeholder="Enter the word">
            </div>
            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-primary" type="button" onclick="checkDictation('{{ loop.index0 }}', '{{ item.lemma | lower }}')">
                    Check Answer
                </button>
                <button class="btn btn-outline-light" type="button" onclick="revealDictation('{{ loop.index0 }}', '{{ item.lemma }}')">
                    Reveal
                </button>
            </div>
            <div class="mt-3" id="feedback-{{ loop.index0 }}"></div>
            <div class="mt-3 text-muted small" id="details-{{ loop.index0 }}" style="display: none;">
                <strong>Definition:</strong> {{ item.definition }}<br>
                {% if item.cn_gloss %}
                <strong>中文提示：</strong> {{ item.cn_gloss }}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
const scored = new Set();

function playAudio(index) {
    const audio = document.getElementById(`audio-${index}`);
    if (audio) {
        audio.playbackRate = 1.0;
        audio.currentTime = 0;
        audio.play();
    }
}

function slowPlay(index) {
    const audio = document.getElementById(`audio-${index}`);
    if (audio) {
        audio.playbackRate = 0.8;
        audio.currentTime = 0;
        audio.play();
    }
}

function checkDictation(index, answer) {
    const input = document.getElementById(`response-${index}`);
    const feedback = document.getElementById(`feedback-${index}`);
    const details = document.getElementById(`details-${index}`);
    if (!input || !feedback) return;

    const userValue = (input.value || '').trim().toLowerCase();
    if (!userValue) {
        feedback.innerHTML = '<span class="text-warning"><i class="fas fa-info-circle me-1"></i>Try typing your best guess first.</span>';
        return;
    }

    if (userValue === answer.toLowerCase()) {
        feedback.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>Perfect! Keep that pronunciation locked in.</span>';
        if (details) details.style.display = 'block';
        scored.add(index);
    } else {
        feedback.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i>Close! Replay the audio and try again.</span>';
    }
}

function revealDictation(index, answer) {
    const feedback = document.getElementById(`feedback-${index}`);
    const details = document.getElementById(`details-${index}`);
    if (feedback) {
        feedback.innerHTML = `<span class="text-info"><i class="fas fa-eye me-1"></i>The word was <strong>${answer}</strong>.</span>`;
    }
    if (details) details.style.display = 'block';
}
</script>
{% endblock %}
