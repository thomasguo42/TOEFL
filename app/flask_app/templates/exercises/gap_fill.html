{% extends "base.html" %}

{% block title %}Contextual Gap-Fill - TOEFL Vocabulary Studio{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="mb-0"><i class="fas fa-file-alt me-2 text-warning"></i>Contextual Gap-Fill</h2>
                <a class="btn btn-primary"
                   href="{{ url_for('contextual_gap_fill') }}"
                   data-loading-target="{{ url_for('contextual_gap_fill') }}"
                   data-loading-generator="{{ url_for('generate_gap_fill_async') }}"
                   data-loading-title="Contextual Gap-Fill"
                   data-loading-message="Gemini 2.5 Flash Lite 正在刷新语境填空题…">
                    <i class="fas fa-sync-alt me-1"></i> Refresh Questions
                </a>
            </div>
            <p class="text-muted mb-0">
                AI-generated TOEFL-style sentences with smart distractors. Click refresh to get new questions.
            </p>
        </div>

        {% for item in exercises %}
        {% set outer_index = loop.index0 %}
        <div class="card p-4 mb-4" data-question="{{ outer_index }}" data-answer="{{ item.answer }}">
            <h5 class="text-uppercase text-muted mb-3" style="letter-spacing: 0.12em;">
                Question {{ loop.index }}
            </h5>
            <p style="font-size: 1.15rem; line-height: 1.7;">
                {{ item.sentence }}
            </p>

            <div class="mt-3">
                {% for option in item.options %}
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="gap-{{ outer_index }}"
                           id="gap-{{ outer_index }}-{{ loop.index0 }}" value="{{ option }}"
                           data-rationale="{{ item.rationales[option]|default('')|escape }}">
                    <label class="form-check-label" for="gap-{{ outer_index }}-{{ loop.index0 }}">
                        {{ option }}
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-primary" type="button"
                        onclick='checkGapFill({{ outer_index }}, "{{ item.answer|replace('"', '&quot;') }}")'>
                    Check Answer
                </button>
                <button class="btn btn-outline-light" type="button"
                        onclick='revealGapFill({{ outer_index }}, "{{ item.answer|replace('"', '&quot;') }}")'>
                    Reveal
                </button>
            </div>

            <div class="mt-2 text-info small" id="gap-rationale-{{ outer_index }}"></div>
            <div class="mt-3" id="gap-feedback-{{ outer_index }}"></div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function checkGapFill(index, answer) {
    const groupName = `gap-${index}`;
    const selected = document.querySelector(`input[name="${groupName}"]:checked`);
    const feedback = document.getElementById(`gap-feedback-${index}`);
    const rationaleBox = document.getElementById(`gap-rationale-${index}`);

    if (!feedback) return;
    if (!selected) {
        feedback.innerHTML = '<span class="text-warning"><i class="fas fa-info-circle me-1"></i>Select an option first.</span>';
        return;
    }

    const rationale = selected.dataset.rationale || '';
    const isCorrect = selected.value.trim().toLowerCase() === answer.trim().toLowerCase();
    const toneClass = isCorrect ? 'text-success' : 'text-danger';
    if (rationaleBox) {
        rationaleBox.innerHTML = rationale ? `<span class="${toneClass}"><i class="fas fa-lightbulb me-1"></i>${rationale}</span>` : '';
    }

    if (isCorrect) {
        feedback.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>Nice! The sentence sounds natural.</span>`;
    } else {
        feedback.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>Not quite. Re-read the tone of the sentence.</span>`;
    }
}

function revealGapFill(index, answer) {
    const feedback = document.getElementById(`gap-feedback-${index}`);
    const correctOption = [...document.querySelectorAll(`input[name="gap-${index}"]`)].find(opt => opt.value === answer);
    const rationaleBox = document.getElementById(`gap-rationale-${index}`);
    if (feedback) {
        feedback.innerHTML = `<span class="text-info"><i class="fas fa-eye me-1"></i>The best fit is <strong>${answer}</strong>.</span>`;
    }
    if (rationaleBox && correctOption) {
        const rationale = correctOption.dataset.rationale || '';
        rationaleBox.innerHTML = rationale ? `<span class="text-success"><i class="fas fa-lightbulb me-1"></i>${rationale}</span>` : '';
    }
}

document.querySelectorAll('[data-question]').forEach((card) => {
    const index = card.dataset.question;
    const answer = (card.dataset.answer || '').trim().toLowerCase();
    const inputs = card.querySelectorAll(`input[name="gap-${index}"]`);
    const rationaleBox = document.getElementById(`gap-rationale-${index}`);
    inputs.forEach((input) => {
        input.addEventListener('change', () => {
            if (rationaleBox) {
                const rationale = input.dataset.rationale || '';
                const toneClass = input.value.trim().toLowerCase() === answer ? 'text-success' : 'text-danger';
                rationaleBox.innerHTML = rationale ? `<span class="${toneClass}"><i class="fas fa-lightbulb me-1"></i>${rationale}</span>` : '';
            }
        });
    });
});
</script>
{% endblock %}
