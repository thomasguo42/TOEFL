{% extends "base.html" %}

{% block title %}Synonym Showdown - TOEFL Vocabulary Studio{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="mb-0"><i class="fas fa-exchange-alt me-2 text-success"></i>Synonym Showdown</h2>
                <a class="btn btn-primary"
                   href="{{ url_for('synonym_showdown') }}"
                   data-loading-target="{{ url_for('synonym_showdown') }}"
                   data-loading-generator="{{ url_for('generate_synonym_async') }}"
                   data-loading-title="Synonym Showdown"
                   data-loading-message="Gemini 2.5 Flash Lite 正在更新近义词对比题…">
                    <i class="fas fa-sync-alt me-1"></i> Refresh Questions
                </a>
            </div>
            <p class="text-muted mb-0">
                AI-generated synonym questions with Chinese explanations. Click refresh for new questions.
            </p>
        </div>

        {% for item in exercises %}
        {% set outer_index = loop.index0 %}
        <div class="card p-4 mb-4" data-question="{{ outer_index }}" data-answer="{{ item.answer }}">
            <h5 class="text-uppercase text-muted mb-3" style="letter-spacing: 0.12em;">
                Question {{ loop.index }}
            </h5>
            <p class="mb-3" style="font-size: 1.1rem; line-height: 1.7;">
                {{ item.sentence | markdown_bold | safe }}
            </p>
            <p class="text-muted small mb-3">
                <i class="fas fa-question-circle me-1"></i>Which synonym best replaces the highlighted word?
            </p>

            <div class="mt-2">
                {% for option in item.options %}
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="syn-{{ outer_index }}"
                           id="syn-{{ outer_index }}-{{ loop.index0 }}" value="{{ option }}"
                           data-rationale="{{ item.rationales[option]|default('')|escape }}">
                    <label class="form-check-label" for="syn-{{ outer_index }}-{{ loop.index0 }}">
                        {{ option }}
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-primary" type="button"
                        onclick='checkSynonym({{ outer_index }}, "{{ item.answer|replace('"', '&quot;')|replace("'", '&#39;') }}", "{{ item.explanation_cn|replace('"', '&quot;')|replace("'", '&#39;') }}")'>
                    Check Answer
                </button>
                <button class="btn btn-outline-light" type="button"
                        onclick='revealSynonym({{ outer_index }}, "{{ item.answer|replace('"', '&quot;')|replace("'", '&#39;') }}", "{{ item.explanation_cn|replace('"', '&quot;')|replace("'", '&#39;') }}")'>
                    Reveal
                </button>
            </div>

            <div class="mt-3" id="syn-feedback-{{ outer_index }}"></div>
            <div class="mt-2 text-info small" id="syn-rationale-{{ outer_index }}"></div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function checkSynonym(index, answer, explanation) {
    const groupName = `syn-${index}`;
    const selected = document.querySelector(`input[name="${groupName}"]:checked`);
    const feedback = document.getElementById(`syn-feedback-${index}`);
    const rationaleBox = document.getElementById(`syn-rationale-${index}`);

    if (!feedback) return;
    if (!selected) {
        feedback.innerHTML = '<span class="text-warning"><i class="fas fa-info-circle me-1"></i>Select an option first.</span>';
        return;
    }

    const rationale = selected.dataset.rationale || '';
    const isCorrect = selected.value.trim().toLowerCase() === answer.trim().toLowerCase();
    const toneClass = isCorrect ? 'text-success' : 'text-danger';
    if (rationaleBox) {
        rationaleBox.innerHTML = rationale ? `<span class="${toneClass}"><i class="fas fa-lightbulb me-1"></i>${rationale}</span>` : '';
    }

    if (isCorrect) {
        feedback.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>Correct! ${explanation}</span>`;
    } else {
        feedback.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i>再想一想：${explanation}</span>`;
    }
}

function revealSynonym(index, answer, explanation) {
    const feedback = document.getElementById(`syn-feedback-${index}`);
    const rationaleBox = document.getElementById(`syn-rationale-${index}`);
    if (feedback) {
        feedback.innerHTML = `<span class="text-info"><i class="fas fa-eye me-1"></i>最佳选项是 <strong>${answer}</strong>。${explanation}</span>`;
    }
    if (rationaleBox) {
        const correctOption = [...document.querySelectorAll(`input[name="syn-${index}"]`)].find(opt => opt.value === answer);
        const rationale = correctOption ? (correctOption.dataset.rationale || '') : '';
        rationaleBox.innerHTML = rationale ? `<span class="text-success"><i class="fas fa-lightbulb me-1"></i>${rationale}</span>` : '';
    }
}

document.querySelectorAll('[data-question]').forEach((card) => {
    const index = card.dataset.question;
    const answer = (card.dataset.answer || '').trim().toLowerCase();
    const inputs = card.querySelectorAll(`input[name="syn-${index}"]`);
    const rationaleBox = document.getElementById(`syn-rationale-${index}`);
    inputs.forEach((input) => {
        input.addEventListener('change', () => {
            if (rationaleBox) {
                const rationale = input.dataset.rationale || '';
                const toneClass = input.value.trim().toLowerCase() === answer ? 'text-success' : 'text-danger';
                rationaleBox.innerHTML = rationale ? `<span class="${toneClass}"><i class="fas fa-lightbulb me-1"></i>${rationale}</span>` : '';
            }
        });
    });
});
</script>
{% endblock %}
