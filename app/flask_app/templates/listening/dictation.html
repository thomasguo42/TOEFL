{% extends "base.html" %}

{% block title %}AI Dictation Trainer - TOEFL Listening{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/listening.css') }}">
{% endblock %}

{% block content %}
<div class="listening-wrapper">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between listening-header mb-4">
        <div>
            <h1 class="h2 fw-bold text-dark listening-section-title mb-2">
                AI Dictation Trainer
            </h1>
            <p class="text-muted listening-lead">
                Listen and type exactly what you hear (5 exercises)
            </p>
        </div>
        <div>
            <button id="regenerate-all-btn" class="btn btn-warning listening-btn me-2">
                <i class="fas fa-redo me-2"></i>Regenerate All
            </button>
            <a href="{{ url_for('listening_dashboard') }}" class="btn btn-outline-secondary listening-btn listening-btn-sm">
                <span class="me-1">‚Üê</span> Back
            </a>
        </div>
    </div>

    <div class="listening-card listening-card--compact mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-6">
                <label class="form-label fw-semibold" for="dictation-topic-input">Topic (Optional)</label>
                <input
                    type="text"
                    id="dictation-topic-input"
                    class="form-control"
                    placeholder="e.g., Biology, Art History, Environmental Ethics"
                    value="{{ dictation_filters.topic }}"
                >
            </div>
            <div class="col-md-4 col-lg-3">
                <label class="form-label fw-semibold" for="dictation-difficulty-select">Difficulty</label>
                <select id="dictation-difficulty-select" class="form-select">
                    <option value="easy" {% if dictation_filters.difficulty == 'easy' %}selected{% endif %}>Easy</option>
                    <option value="medium" {% if dictation_filters.difficulty == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="hard" {% if dictation_filters.difficulty == 'hard' %}selected{% endif %}>Hard</option>
                </select>
            </div>
            <div class="col-md-2 col-lg-3 text-md-end">
                <button id="dictation-apply-btn" class="btn btn-primary listening-btn w-100">
                    <i class="fas fa-magic me-2"></i>Generate 5 Exercises
                </button>
            </div>
        </div>
    </div>

    {% if sentences and sentences|length > 0 %}
    <!-- Exercise Cards -->
    {% for sentence in sentences %}
    <div class="listening-card mb-4" id="exercise-{{ loop.index }}">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h3 class="h5 fw-semibold text-dark mb-0">Exercise {{ loop.index }} of {{ sentences|length }}</h3>
            <span class="badge bg-primary">{{ sentence.topic }}</span>
        </div>

        <div class="listening-audio-card mb-3">
            <audio id="audio-{{ sentence.id }}" controls class="w-100">
                <source src="{{ url_for('static', filename=sentence.audio_url) }}" type="audio/mpeg">
            </audio>
        </div>

        <div class="exercise-input" id="input-section-{{ sentence.id }}">
            <label for="user-input-{{ sentence.id }}" class="form-label fw-semibold">Type what you hear</label>
            <textarea
                id="user-input-{{ sentence.id }}"
                rows="3"
                class="form-control"
                placeholder="Listen carefully and type the sentence here..."
            ></textarea>
            <div class="listening-actions mt-3">
                <button class="submit-btn btn btn-primary listening-btn" data-id="{{ sentence.id }}">
                    Submit Answer
                </button>
                <button class="replay-btn btn btn-outline-secondary listening-btn" data-id="{{ sentence.id }}">
                    <i class="fas fa-volume-up me-2"></i>Replay
                </button>
            </div>
        </div>

        <div class="exercise-results d-none" id="results-{{ sentence.id }}">
            <div class="alert alert-info">
                <div class="fw-semibold mb-1">Score: <span id="score-{{ sentence.id }}">--</span></div>
                <div class="small" id="word-count-{{ sentence.id }}">--</div>
            </div>

            <div class="mb-3">
                <h4 class="h6 fw-semibold">Word Analysis</h4>
                <div id="word-analysis-{{ sentence.id }}" class="listening-analysis-list"></div>
            </div>

            <div class="mb-3">
                <h4 class="h6 fw-semibold">Correct Text</h4>
                <div class="listening-transcript">{{ sentence.text }}</div>
            </div>

            <button class="try-again-btn btn btn-outline-secondary listening-btn" data-id="{{ sentence.id }}">
                Try Again
            </button>
        </div>
    </div>
    {% endfor %}

    <div class="text-center mb-4">
        <button id="submit-all-btn" class="btn btn-success listening-btn btn-lg">
            Submit All Answers
        </button>
    </div>

    {% else %}
    <div class="listening-card text-center">
        <div class="listening-empty-icon">üéß</div>
        <h3 class="h4 fw-semibold text-dark mb-3">
            No Dictation Exercises Available
        </h3>
        <p class="text-muted mb-4">
            Generate 5 new sentences to start practicing.
        </p>
        <div class="row justify-content-center mb-3">
            <div class="col-md-6">
                <label class="form-label fw-semibold" for="topic-input">Topic (Optional)</label>
                <input type="text" id="topic-input" class="form-control" placeholder="e.g., Biology, Art History">
            </div>
            <div class="col-md-6">
                <label class="form-label fw-semibold" for="difficulty-select">Difficulty</label>
                <select id="difficulty-select" class="form-select">
                    <option value="easy">Easy</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
        </div>
        <button id="generate-btn" class="btn btn-primary listening-btn btn-lg">
            Generate Exercises
        </button>
    </div>
    {% endif %}
</div>

<script>
const sentencesData = {{ sentences | tojson | safe if sentences else '[]' }};

// Submit individual answer
document.querySelectorAll('.submit-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const id = this.dataset.id;
        const userText = document.getElementById(`user-input-${id}`).value.trim();

        if (!userText) {
            alert('Please type something first!');
            return;
        }

        try {
            const response = await fetch(`/listening/api/dictation/${id}/submit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: userText })
            });

            const result = await response.json();
            displayResults(id, result);
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to submit. Please try again.');
        }
    });
});

// Replay audio
document.querySelectorAll('.replay-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.dataset.id;
        document.getElementById(`audio-${id}`).play();
    });
});

// Try again
document.querySelectorAll('.try-again-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const id = this.dataset.id;
        document.getElementById(`results-${id}`).classList.add('d-none');
        document.getElementById(`input-section-${id}`).classList.remove('d-none');
        document.getElementById(`user-input-${id}`).value = '';
    });
});

function displayResults(id, result) {
    document.getElementById(`input-section-${id}`).classList.add('d-none');
    document.getElementById(`results-${id}`).classList.remove('d-none');

    document.getElementById(`score-${id}`).textContent = `${result.score.toFixed(1)}%`;
    document.getElementById(`word-count-${id}`).textContent =
        `${result.correct_count} / ${result.total_words} words correct`;

    const wordAnalysisHtml = result.word_analysis.map((item) => {
        const isCorrect = item.is_correct;
        const statusClass = isCorrect
            ? 'listening-diff-card listening-diff-card--success'
            : 'listening-diff-card listening-diff-card--error';
        const icon = isCorrect ? '‚úì' : '‚úó';

        return `
            <div class="${statusClass}">
                <div class="listening-diff-card__icon">${icon}</div>
                <div class="flex-grow-1">
                    <div class="listening-diff-card__meta">
                        <span class="text-muted">Expected:</span>
                        <span class="fw-semibold">${item.correct_word}</span>
                    </div>
                    ${!isCorrect ? `
                        <div class="listening-diff-card__meta mt-1">
                            <span class="text-muted">You typed:</span>
                            <span class="fw-semibold text-danger">${item.user_word || '(missing)'}</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
    document.getElementById(`word-analysis-${id}`).innerHTML = wordAnalysisHtml;
}

const dictationTopicInput = document.getElementById('dictation-topic-input');
const dictationDifficultySelect = document.getElementById('dictation-difficulty-select');
const dictationApplyBtn = document.getElementById('dictation-apply-btn');
const regenerateAllBtn = document.getElementById('regenerate-all-btn');
const generateBtn = document.getElementById('generate-btn');

regenerateAllBtn?.setAttribute('data-default-text', regenerateAllBtn.innerHTML);
dictationApplyBtn?.setAttribute('data-default-text', dictationApplyBtn.innerHTML);
generateBtn?.setAttribute('data-default-text', generateBtn.innerHTML);

function setButtonState(btn, isLoading, loadingText, defaultText) {
    if (!btn) return;
    if (isLoading) {
        btn.disabled = true;
        btn.innerHTML = loadingText;
    } else {
        btn.disabled = false;
        btn.innerHTML = defaultText;
    }
}

async function generateDictationExercises(trigger) {
    const topic = dictationTopicInput?.value.trim() || null;
    const difficulty = dictationDifficultySelect?.value || 'medium';
    const triggerBtn = trigger || generateBtn || dictationApplyBtn || regenerateAllBtn;

    setButtonState(triggerBtn, true, '<i class="fas fa-spinner fa-spin me-2"></i>Generating...', triggerBtn?.dataset?.defaultText || triggerBtn?.innerHTML || 'Generate');

    try {
        const response = await fetch('/listening/api/dictation/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, difficulty })
        });
        const result = await response.json();
        if (result.success) {
            window.location.reload();
        } else {
            alert(`Failed to generate: ${result.message}`);
            setButtonState(triggerBtn, false, '', triggerBtn?.dataset?.defaultText || triggerBtn?.innerHTML || 'Generate');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate. Please try again.');
        setButtonState(triggerBtn, false, '', triggerBtn?.dataset?.defaultText || triggerBtn?.innerHTML || 'Generate');
    }
}

regenerateAllBtn?.addEventListener('click', () => generateDictationExercises(regenerateAllBtn));
dictationApplyBtn?.addEventListener('click', () => generateDictationExercises(dictationApplyBtn));
generateBtn?.addEventListener('click', () => generateDictationExercises(generateBtn));
</script>
{% endblock %}
