{% extends "base.html" %}

{% block title %}Vocabulary Session - TOEFL Vocabulary Studio{% endblock %}

{% block extra_css %}
<style>
    .vocab-card {
        background: linear-gradient(135deg, #ffffff 0%, #eef4ff 100%);
        border: 1px solid var(--toefl-border);
        border-radius: 1.5rem;
        padding: 2rem;
        box-shadow: 0 24px 32px -12px rgba(14, 165, 233, 0.18);
    }

    .word-lemma {
        font-size: 3rem;
        font-weight: 700;
        color: var(--toefl-text);
    }

    .definition-box {
        background: #f5f8ff;
        border: 1px solid var(--toefl-border-light);
        border-radius: 0.75rem;
        padding: 1.5rem;
    }

    .definition-box p {
        color: var(--toefl-text) !important;
    }

    .grade-btn {
        border-radius: 0.75rem;
        padding: 1rem;
        font-weight: 600;
        border: 1px solid var(--toefl-border);
        transition: all 0.2s;
    }

    .grade-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .progress-badge {
        background: rgba(14, 165, 233, 0.12);
        color: var(--teal-400);
        border-radius: 1rem;
        padding: 0.5rem 1rem;
        font-weight: 600;
    }

    .review-insight {
        background: #ffffff;
        border: 1px solid var(--toefl-border);
        border-radius: 1rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .exercise-card {
        background: #ffffff;
        border: 1px solid var(--toefl-border);
        border-radius: 1rem;
        transition: transform 0.2s ease;
    }

    .exercise-card:hover {
        transform: translateY(-4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        {% if goal_met %}
        <div class="alert alert-success d-flex align-items-center gap-2">
            <i class="fas fa-check-circle"></i>
            <span>Daily target complete! Lock in memory with the bonus drills below.</span>
        </div>
        {% endif %}

        <!-- Progress Bar -->
        <div class="card mb-4 p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">Daily Progress</h5>
                    <p class="text-muted mb-0">
                        {{ progress.reviewed }} / {{ progress.goal }} words reviewed today
                    </p>
                </div>
                <div class="text-end">
                    <span class="progress-badge">
                        <i class="fas fa-layer-group me-1"></i>
                        {{ card.remaining if card else 0 }} remaining
                    </span>
                </div>
            </div>
            <div class="progress mt-3" style="height: 10px;">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: {{ (progress.reviewed / progress.goal * 100) if progress.goal > 0 else 0 }}%;">
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#goal-adjust-collapse">
                    <i class="fas fa-sliders-h me-2"></i>Adjust Daily Goal
                </button>
                <div class="collapse mt-3" id="goal-adjust-collapse">
                    <form id="daily-goal-form" class="row g-2 align-items-center">
                        <div class="col-auto">
                            <label for="daily-goal-input" class="col-form-label text-muted">Words / day</label>
                        </div>
                        <div class="col-auto">
                            <input type="number" min="1" max="1000" class="form-control form-control-sm"
                                   id="daily-goal-input" value="{{ progress.goal }}">
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-primary" type="submit">
                                <i class="fas fa-save me-1"></i>Save
                            </button>
                        </div>
                        <div class="col-12">
                            <small id="goal-update-feedback" class="text-muted"></small>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Vocabulary Card -->
        {% if card %}
        <div class="vocab-card" id="vocab-card">
            <div class="row">
                <div class="col-12">
                    <p class="text-uppercase text-muted mb-2" style="letter-spacing: 0.15em; font-size: 0.75rem;">
                        Word
                    </p>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <h1 class="word-lemma mb-0">{{ card.word.lemma }}</h1>
                        {% if card.audio_url %}
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="playWordAudio()">
                            <i class="fas fa-volume-up me-1"></i>Play
                        </button>
                        <audio id="word-audio" src="{{ card.audio_url }}" preload="auto"></audio>
                        {% endif %}
                    </div>
                    {% if card.word.cn_gloss %}
                    <p class="text-muted mb-4 cn-gloss-hidden" id="cn-gloss" style="color: var(--teal-300) !important; font-size: 1.1rem; display: none;">
                        <i class="fas fa-language me-2"></i>{{ card.word.cn_gloss }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="definition-box mt-4" id="definition-box" style="display: none;">
                <p class="text-uppercase text-muted mb-2" style="letter-spacing: 0.1em; font-size: 0.75rem;">
                    Definition
                </p>
                <p class="mb-3" style="font-size: 1.1rem; line-height: 1.6;">
                    {{ card.word.definition }}
                </p>

                <p class="text-uppercase text-muted mb-2 mt-4" style="letter-spacing: 0.1em; font-size: 0.75rem;">
                    TOEFL Example
                </p>
                <p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: var(--slate-300);">
                    {{ card.word.example }}
                </p>
            </div>

            <!-- Think first prompt -->
            <div class="text-center mt-4" id="think-prompt">
                <p class="text-muted" style="font-size: 0.95rem;">
                    <i class="fas fa-brain me-2"></i>Think about the meaning before grading
                </p>
                <button class="btn btn-outline-secondary btn-sm mt-2" onclick="revealDetails()">
                    <i class="fas fa-eye me-1"></i>Show Details
                </button>
            </div>

            <!-- Grade Buttons -->
            <div class="row g-3 mt-4" id="grade-buttons">
                <div class="col-md-4">
                    <button class="btn btn-success grade-btn w-100" onclick="gradeWord('recognize')" id="btn-recognize">
                        <div class="d-flex flex-column align-items-center">
                            <span style="font-size: 1.1rem;">Recognize</span>
                            <small class="mt-1" style="font-size: 0.85rem;">稳得住</small>
                        </div>
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning grade-btn w-100" onclick="gradeWord('barely')" id="btn-barely">
                        <div class="d-flex flex-column align-items-center">
                            <span style="font-size: 1.1rem;">Barely</span>
                            <small class="mt-1" style="font-size: 0.85rem;">模糊记得</small>
                        </div>
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-danger grade-btn w-100" onclick="gradeWord('not')" id="btn-not">
                        <div class="d-flex flex-column align-items-center">
                            <span style="font-size: 1.1rem;">Not Yet</span>
                            <small class="mt-1" style="font-size: 0.85rem;">完全陌生</small>
                        </div>
                    </button>
                </div>
            </div>

            <p class="text-center text-muted mt-3 mb-0" id="submitting-text" style="display: none;">
                <i class="fas fa-spinner fa-spin me-2"></i>Logging your response…
            </p>
        </div>

        <!-- Review Insight (shown after grading) -->
        <div id="review-insight" class="review-insight" style="display: none;">
            <h6 class="text-uppercase" style="color: var(--teal-400); letter-spacing: 0.1em;">Review Logged</h6>
            <p class="mb-2">Next review scheduled for: <strong id="next-due"></strong></p>
            <p class="mb-0 text-muted">
                <small>Easiness: <span id="easiness"></span> | Interval: <span id="interval"></span> days</small>
            </p>
        </div>

        {% else %}
        <!-- Session Complete -->
        <div class="text-center py-5">
            <div class="card p-5">
                <h2 class="mb-3">Session complete</h2>
                <p class="text-muted mb-4">
                    You've triaged every assigned word today. Choose a mastery boost to reinforce {{ todays_words|length }} words.
                </p>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    <a href="{{ url_for('vocab_session') }}" class="btn btn-primary">
                        <i class="fas fa-redo me-2"></i>Restart Session
                    </a>
                    <a href="{{ url_for('main_dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-line me-2"></i>View Dashboard
                    </a>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-1">
            <div class="col-md-6">
                <div class="exercise-card h-100 p-4 text-start">
                    <h4 class="mb-2">
                        <i class="fas fa-volume-up me-2 text-info"></i>Dictation Challenge
                    </h4>
                    <p class="text-muted mb-3">
                        Play native audio and type what you hear. Prioritized by tricky pronunciations.
                    </p>
                    <a href="{{ url_for('dictation_challenge') }}" class="btn btn-outline-secondary w-100">
                        Start Dictation
                    </a>
                </div>
            </div>
            <div class="col-md-6">
                <div class="exercise-card h-100 p-4 text-start">
                    <h4 class="mb-2">
                        <i class="fas fa-file-alt me-2 text-warning"></i>Contextual Gap-Fill
                    </h4>
                    <p class="text-muted mb-3">
                        Slot your words into TOEFL sentences with smart distractors.
                    </p>
                    <a href="{{ url_for('contextual_gap_fill') }}" class="btn btn-outline-secondary w-100">
                        Launch Gap-Fill
                    </a>
                </div>
            </div>
            <div class="col-md-6">
                <div class="exercise-card h-100 p-4 text-start">
                    <h4 class="mb-2">
                        <i class="fas fa-exchange-alt me-2 text-success"></i>Synonym Showdown
                    </h4>
                    <p class="text-muted mb-3">
                        Compare nuance with concise Chinese feedback on every option.
                    </p>
                    <a href="{{ url_for('synonym_showdown') }}" class="btn btn-outline-secondary w-100">
                        Train Synonyms
                    </a>
                </div>
            </div>
            <div class="col-md-6">
                <div class="exercise-card h-100 p-4 text-start">
                    <h4 class="mb-2">
                        <i class="fas fa-book-reader me-2 text-primary"></i>Reading Immersion
                    </h4>
                    <p class="text-muted mb-3">
                        Pick a TOEFL topic to see the same words in a 200-word passage.
                    </p>
                    <a href="{{ url_for('reading_immersion') }}" class="btn btn-outline-secondary w-100">
                        Enter Reading Mode
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
let displayedAt = performance.now();
const sessionId = '{{ session_id }}';
const wordId = {{ card.word.id if card else 'null' }};
let detailsRevealed = false;

function revealDetails() {
    if (!detailsRevealed) {
        document.getElementById('definition-box').style.display = 'block';
        document.getElementById('cn-gloss').style.display = 'block';
        document.getElementById('think-prompt').style.display = 'none';
        detailsRevealed = true;
    }
}

function disableButtons() {
    const recognizeBtn = document.getElementById('btn-recognize');
    const barelyBtn = document.getElementById('btn-barely');
    const notBtn = document.getElementById('btn-not');
    if (recognizeBtn) recognizeBtn.disabled = true;
    if (barelyBtn) barelyBtn.disabled = true;
    if (notBtn) notBtn.disabled = true;
    const submittingText = document.getElementById('submitting-text');
    if (submittingText) submittingText.style.display = 'block';
}

function gradeWord(grade) {
    if (!wordId) return;

    if (!detailsRevealed) {
        revealDetails();
        setTimeout(() => submitGrade(grade), 2000);
    } else {
        submitGrade(grade);
    }
}

function submitGrade(grade) {
    disableButtons();

    const now = performance.now();
    const latencyMs = Math.round(now - displayedAt);

    fetch(`/session/${sessionId}/grade`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            word_id: wordId,
            grade: grade,
            latency_ms: latencyMs
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.review) {
            const nextDue = new Date(data.review.next_due).toLocaleString();
            document.getElementById('next-due').textContent = nextDue;
            document.getElementById('easiness').textContent = data.review.easiness.toFixed(2);
            document.getElementById('interval').textContent = data.review.interval.toFixed(1);
            document.getElementById('review-insight').style.display = 'block';
        }

        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to submit grade. Please try again.');
        window.location.reload();
    });
}

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        displayedAt = performance.now();
    }
});

const goalForm = document.getElementById('daily-goal-form');
if (goalForm) {
    goalForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const feedback = document.getElementById('goal-update-feedback');
        feedback.textContent = 'Saving…';
        const newGoal = document.getElementById('daily-goal-input').value;
        try {
            const response = await fetch('{{ url_for("api_update_daily_goal") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ daily_goal: newGoal })
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'Failed to update goal');
            }
            feedback.textContent = `Updated! New target: ${data.daily_goal} words.`;
        } catch (error) {
            feedback.textContent = error.message;
        }
    });
}

function playWordAudio() {
    const audio = document.getElementById('word-audio');
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}
</script>
{% endblock %}
