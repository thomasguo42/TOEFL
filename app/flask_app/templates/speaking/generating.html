{% extends "base.html" %}

{% block title %}Generating Task - TOEFL Speaking{% endblock %}

{% block extra_css %}
<style>
    .generating-container {
        max-width: 700px;
        margin: 0 auto;
        padding: 4rem 1rem;
        text-align: center;
    }

    .loader {
        width: 80px;
        height: 80px;
        border: 8px solid #e2e8f0;
        border-top: 8px solid var(--teal-400);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .generating-header {
        background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 1.5rem;
        margin-bottom: 2rem;
    }

    .generating-header h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
    }

    .steps {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 1rem;
        padding: 2rem;
        text-align: left;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
        background: #f8fafc;
    }

    .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--teal-400);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .step.active {
        background: linear-gradient(135deg, #e0f2fe 0%, #cffafe 100%);
        border: 2px solid var(--teal-400);
    }

    .step.completed .step-icon {
        background: #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="generating-container">
    <div class="generating-header">
        <h1><i class="fas fa-magic me-2"></i>Generating Your Speaking Task</h1>
        <p class="mb-0">Task {{ task_number }}: {{ task_name }}</p>
    </div>

    <div class="loader"></div>

    <div class="steps">
        <h4 class="mb-4 text-center">Generation Process</h4>

        <div class="step" id="step1">
            <div class="step-icon"><i class="fas fa-lightbulb"></i></div>
            <div>
                <strong>Creating task content</strong>
                <div class="text-muted small">Generating prompts and materials with AI</div>
            </div>
        </div>

        {% if task_number > 1 %}
        <div class="step" id="step2">
            <div class="step-icon"><i class="fas fa-volume-up"></i></div>
            <div>
                <strong>Generating audio</strong>
                <div class="text-muted small">Creating listening materials with TTS</div>
            </div>
        </div>
        {% endif %}

        <div class="step" id="step3">
            <div class="step-icon"><i class="fas fa-check"></i></div>
            <div>
                <strong>Finalizing task</strong>
                <div class="text-muted small">Preparing your practice environment</div>
            </div>
        </div>
    </div>

    <p class="text-muted mt-4">
        <i class="fas fa-info-circle me-2"></i>
        This usually takes 5-15 seconds depending on the task type
    </p>
</div>

<script>
// Simulate progress animation
let currentStep = 1;
const maxSteps = {{ 3 if task_number > 1 else 2 }};
const stepDelay = 2000; // Visual feedback delay

function updateStep() {
    if (currentStep <= maxSteps) {
        const stepEl = document.getElementById(`step${currentStep}`);
        if (stepEl) {
            stepEl.classList.add('active');
        }

        // Mark previous as completed
        if (currentStep > 1) {
            const prevStep = document.getElementById(`step${currentStep - 1}`);
            if (prevStep) {
                prevStep.classList.remove('active');
                prevStep.classList.add('completed');
            }
        }

        currentStep++;
        setTimeout(updateStep, stepDelay);
    }
}

// Start animation
setTimeout(updateStep, 500);

// Poll the server to check if generation is complete
const taskNumber = {{ task_number }};
const startTime = Date.now();

function checkTaskReady() {
    fetch(`/speaking/task/${taskNumber}/check`, {
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        if (data.ready) {
            // Mark all steps complete
            for (let i = 1; i <= maxSteps; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                }
            }

            // Redirect to practice page
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 500);
        } else {
            // Check again in 1 second
            setTimeout(checkTaskReady, 1000);
        }
    })
    .catch(error => {
        console.error('Error checking task status:', error);
        // Retry
        setTimeout(checkTaskReady, 1000);
    });
}

// Start checking after a short delay
setTimeout(checkTaskReady, 2000);
</script>
{% endblock %}
