{% extends "base.html" %}

{% block title %}Writing Feedback - {{ task.task_type|capitalize }} - TOEFL{% endblock %}

{% block extra_css %}
<style>
    .feedback-container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 1rem;
    }

    .feedback-header {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .score-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    .main-score {
        text-align: center;
    }

    .main-score-value {
        font-size: 4rem;
        font-weight: 700;
        color: var(--teal-400);
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .main-score-label {
        font-size: 0.9rem;
        color: var(--toefl-text-light);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .subscores {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .subscore-item {
        text-align: center;
        min-width: 100px;
    }

    .subscore-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--teal-400);
        line-height: 1;
    }

    .subscore-label {
        font-size: 0.75rem;
        color: var(--toefl-text-light);
        margin-top: 0.25rem;
    }

    .task-info {
        display: flex;
        gap: 1rem;
        align-items: center;
        font-size: 0.9rem;
        color: var(--toefl-text-light);
        margin-bottom: 1rem;
    }

    /* Two-column layout */
    .feedback-layout {
        display: grid;
        grid-template-columns: 1fr 600px;
        gap: 1.5rem;
        align-items: start;
    }

    @media (max-width: 1400px) {
        .feedback-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Essay Panel (Left) */
    .essay-panel {
        background: white;
        border-radius: 0.75rem;
        padding: 2rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
    }

    .essay-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .essay-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--toefl-text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .word-count-badge {
        background: var(--teal-200);
        color: var(--toefl-text);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .essay-content {
        font-family: 'Georgia', serif;
        font-size: 1.1rem;
        line-height: 2;
        color: var(--toefl-text);
    }

    .essay-paragraph {
        margin-bottom: 1.5rem;
        text-indent: 2rem;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .essay-paragraph:first-of-type {
        text-indent: 0;
    }

    /* Annotation highlighting */
    .annotation {
        position: relative;
        cursor: pointer;
        border-radius: 3px;
        padding: 2px 4px;
        margin: 0 2px;
        transition: all 0.2s;
    }

    .annotation:hover {
        opacity: 0.8;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .annotation-grammar {
        background: rgba(239, 68, 68, 0.2);
        border-bottom: 2px wavy #ef4444;
    }

    .annotation-vocabulary, .annotation-lexical {
        background: rgba(245, 158, 11, 0.2);
        border-bottom: 2px solid #f59e0b;
    }

    .annotation-vague {
        background: rgba(168, 85, 247, 0.2);
        border-bottom: 2px dotted #a855f7;
    }

    .annotation-cohesion {
        background: rgba(34, 197, 94, 0.2);
        border-bottom: 2px dashed #22c55e;
    }

    .annotation-task {
        background: rgba(59, 130, 246, 0.2);
        border-bottom: 2px solid #3b82f6;
    }

    /* Annotation tooltip */
    .annotation-tooltip {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1a1a1a;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        line-height: 1.4;
        max-width: 300px;
        margin-bottom: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 100;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .annotation:hover .annotation-tooltip {
        display: block;
    }

    .annotation-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1a1a1a;
    }

    /* Feedback Panel (Right) */
    .feedback-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .feedback-section {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .section-icon {
        font-size: 1.5rem;
        color: var(--teal-400);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--toefl-text);
        margin: 0;
    }

    .coach-summary {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-left: 4px solid var(--teal-400);
        padding: 1.25rem;
        border-radius: 0.5rem;
        font-size: 1rem;
        line-height: 1.8;
        color: var(--toefl-text);
        font-style: italic;
    }

    .feedback-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .feedback-item {
        display: flex;
        align-items: start;
        gap: 0.75rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        background: #f9fafb;
        border-radius: 0.5rem;
        border-left: 3px solid #e5e7eb;
    }

    .feedback-item.strength {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-left-color: #22c55e;
    }

    .feedback-item.improvement {
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        border-left-color: #f59e0b;
    }

    .feedback-item-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
        margin-top: 0.125rem;
    }

    .feedback-item.strength .feedback-item-icon {
        color: #22c55e;
    }

    .feedback-item.improvement .feedback-item-icon {
        color: #f59e0b;
    }

    .feedback-item-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--toefl-text);
    }

    .grammar-issue {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .grammar-issue-text {
        font-family: 'Georgia', serif;
        font-size: 0.95rem;
        color: #ef4444;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .grammar-correction {
        font-family: 'Georgia', serif;
        font-size: 0.95rem;
        color: #22c55e;
        font-weight: 500;
    }

    .vocab-suggestion {
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .vocab-original {
        font-family: 'Georgia', serif;
        color: #f59e0b;
        font-weight: 600;
    }

    .vocab-arrow {
        color: var(--toefl-text-light);
        margin: 0 0.5rem;
    }

    .vocab-better {
        font-family: 'Georgia', serif;
        color: #22c55e;
        font-weight: 600;
    }

    .vocab-reason {
        font-size: 0.9rem;
        color: var(--toefl-text-light);
        margin-top: 0.5rem;
    }

    .annotation-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 0.5rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 3px;
    }

    .legend-color.grammar {
        background: rgba(239, 68, 68, 0.3);
        border-bottom: 2px wavy #ef4444;
    }

    .legend-color.vocabulary {
        background: rgba(245, 158, 11, 0.3);
        border-bottom: 2px solid #f59e0b;
    }

    .legend-color.vague {
        background: rgba(168, 85, 247, 0.3);
        border-bottom: 2px dotted #a855f7;
    }

    .legend-color.cohesion {
        background: rgba(34, 197, 94, 0.3);
        border-bottom: 2px dashed #22c55e;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .btn-action {
        flex: 1;
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-revise {
        background: var(--teal-400);
        color: white;
    }

    .btn-revise:hover {
        background: #0891b2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .btn-new-task {
        background: white;
        color: var(--toefl-text);
        border: 2px solid #d1d5db;
    }

    .btn-new-task:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
    }

    .btn-dashboard {
        background: white;
        color: var(--toefl-text);
        border: 2px solid #d1d5db;
    }

    .btn-dashboard:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
    }

    /* Revision mode */
    .revision-mode {
        display: none;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .revision-mode.active {
        display: block;
    }

    .revision-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #92400e;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    #revisionEditor {
        width: 100%;
        min-height: 400px;
        padding: 1.5rem;
        border: 2px solid #fbbf24;
        border-radius: 0.75rem;
        font-family: 'Georgia', serif;
        font-size: 1.1rem;
        line-height: 2;
        resize: vertical;
        margin-bottom: 1rem;
    }

    #revisionEditor:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .revision-word-count {
        font-size: 0.9rem;
        color: #92400e;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .revision-buttons {
        display: flex;
        gap: 1rem;
    }

    .content-note {
        background: #f0f9ff;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid var(--teal-400);
        font-size: 0.95rem;
        line-height: 1.7;
    }

    .discussion-context {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.25rem;
        line-height: 1.8;
    }

    .discussion-post {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .discussion-meta {
        display: flex;
        gap: 0.5rem;
        align-items: baseline;
        font-size: 0.95rem;
        font-weight: 600;
        color: #1f2937;
    }

    .discussion-stance {
        color: #3b82f6;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
    }

    .discussion-message {
        margin-top: 0.5rem;
        white-space: pre-wrap;
        color: var(--toefl-text);
    }

    .highlight-card {
        background: #eef2ff;
        border-left: 4px solid #6366f1;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .highlight-source {
        font-weight: 700;
        color: #4338ca;
        font-size: 0.9rem;
    }

    .highlight-implication {
        font-size: 0.9rem;
        color: #4b5563;
        margin-top: 0.4rem;
    }
</style>
{% endblock %}

{% block content %}
{% set task_icon = 'book-reader' %}
{% set task_label = 'Integrated Task' %}
{% if task.task_type == 'discussion' %}
    {% set task_icon = 'comments' %}
    {% set task_label = 'Academic Discussion' %}
{% elif task.task_type == 'independent' %}
    {% set task_icon = 'lightbulb' %}
    {% set task_label = 'Independent Task' %}
{% endif %}

<div class="feedback-container">
    <!-- Header with scores -->
    <div class="feedback-header">
        <div class="task-info">
            <span><i class="fas fa-{{ task_icon }}"></i> {{ task_label }}</span>
            <span>|</span>
            <span><i class="fas fa-calendar"></i> {{ response.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
            <span>|</span>
            <span><i class="fas fa-user"></i> {{ user.email }}</span>
        </div>

        <div class="score-display">
            <div class="main-score">
                <div class="main-score-value">{{ "%.1f"|format(feedback.overall_score or 0) }}/30</div>
                <div class="main-score-label">Overall Score</div>
            </div>

            <div class="subscores">
                <div class="subscore-item">
                    <div class="subscore-value">{{ "%.1f"|format(feedback.content_development_score or 0) }}</div>
                    <div class="subscore-label">Content</div>
                </div>
                <div class="subscore-item">
                    <div class="subscore-value">{{ "%.1f"|format(feedback.organization_structure_score or 0) }}</div>
                    <div class="subscore-label">Organization</div>
                </div>
                <div class="subscore-item">
                    <div class="subscore-value">{{ "%.1f"|format(feedback.vocabulary_language_score or 0) }}</div>
                    <div class="subscore-label">Vocabulary</div>
                </div>
                <div class="subscore-item">
                    <div class="subscore-value">{{ "%.1f"|format(feedback.grammar_mechanics_score or 0) }}</div>
                    <div class="subscore-label">Grammar</div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn-action btn-dashboard" onclick="location.href='{{ url_for('writing_dashboard') }}'">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </button>
            <button class="btn-action btn-revise" onclick="enterRevisionMode()">
                <i class="fas fa-edit"></i>
                Revise Essay
            </button>
            <button class="btn-action btn-new-task" onclick="location.href='{{ url_for('writing_dashboard') }}'">
                <i class="fas fa-plus"></i>
                New Task
            </button>
        </div>
    </div>

    <!-- Revision Mode (Initially Hidden) -->
    <div class="revision-mode" id="revisionMode">
        <div class="revision-title">
            <i class="fas fa-edit"></i>
            Revise Your Essay
        </div>
        <p style="color: #92400e; margin-bottom: 1rem;">
            Make improvements based on the feedback below, then submit for a fresh evaluation.
        </p>
        <textarea id="revisionEditor" placeholder="Paste your essay here and make improvements...">{{ response.essay_text }}</textarea>
        <div class="revision-word-count">
            Words: <span id="revisionWordCount">{{ response.word_count }}</span>
        </div>
        <div class="revision-buttons">
            <button class="btn-action btn-secondary-action" onclick="exitRevisionMode()">
                <i class="fas fa-times"></i>
                Cancel
            </button>
            <button class="btn-action btn-primary-action" onclick="submitRevision()" id="submitRevisionBtn">
                <i class="fas fa-paper-plane"></i>
                Submit Revision
            </button>
        </div>
    </div>

    <!-- Main Layout: Essay + Feedback -->
    <div class="feedback-layout">
        <!-- Left: Essay with Annotations -->
        <div class="essay-panel" id="essayPanel">
            <div class="essay-header">
                <div class="essay-title">
                    <i class="fas fa-file-alt"></i>
                    Your Essay
                </div>
                <div class="word-count-badge">
                    {{ response.word_count }} words
                </div>
            </div>

            <div class="annotation-legend">
                <div class="legend-item">
                    <div class="legend-color grammar"></div>
                    <span>Grammar</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color vocabulary"></div>
                    <span>Vocabulary</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color vague"></div>
                    <span>Vague/Unclear</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color cohesion"></div>
                    <span>Cohesion</span>
                </div>
            </div>

            <div class="essay-content" id="essayContent">
                <!-- Essay text will be rendered here with annotations -->
            </div>
        </div>

        <!-- Right: Feedback Categories -->
        <div class="feedback-panel">
            <!-- Coach Summary -->
            <div class="feedback-section">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-heart"></i></div>
                    <h3 class="section-title">Coach Summary</h3>
                </div>
                <div class="coach-summary">
                    {% if feedback.coach_summary %}
                        {{ feedback.coach_summary }}
                    {% else %}
                        <span style="font-style: italic; color: #9ca3af;">No coach summary available. AI analysis may be incomplete.</span>
                    {% endif %}
                </div>
            </div>

            <!-- Strengths -->
            <div class="feedback-section">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-star"></i></div>
                    <h3 class="section-title">Strengths</h3>
                </div>
                <ul class="feedback-list">
                    {% if feedback.strengths and feedback.strengths|length > 0 %}
                        {% for strength in feedback.strengths[:5] %}
                        <li class="feedback-item strength">
                            <div class="feedback-item-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="feedback-item-text">{{ strength }}</div>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li class="feedback-item">
                            <div class="feedback-item-text" style="font-style: italic; color: #9ca3af;">No strength feedback available. AI analysis may be incomplete.</div>
                        </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Areas for Improvement -->
            <div class="feedback-section">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-arrow-up"></i></div>
                    <h3 class="section-title">Areas for Improvement</h3>
                </div>
                <ul class="feedback-list">
                    {% if feedback.improvements and feedback.improvements|length > 0 %}
                        {% for improvement in feedback.improvements[:6] %}
                        <li class="feedback-item improvement">
                            <div class="feedback-item-icon"><i class="fas fa-lightbulb"></i></div>
                            <div class="feedback-item-text">{{ improvement }}</div>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li class="feedback-item">
                            <div class="feedback-item-text" style="font-style: italic; color: #9ca3af;">No improvement suggestions available. AI analysis may be incomplete.</div>
                        </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Grammar Issues -->
            {% if feedback.annotations %}
                {% set grammar_annotations = feedback.annotations | selectattr('type', 'equalto', 'grammar') | list %}
                {% if grammar_annotations %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-spell-check"></i></div>
                        <h3 class="section-title">Grammar Issues</h3>
                    </div>
                    {% for annotation in grammar_annotations[:5] %}
                    <div class="grammar-issue">
                        <div class="grammar-issue-text">
                            <i class="fas fa-times-circle"></i> "{{ annotation.text }}"
                        </div>
                        <div class="grammar-correction">
                            <i class="fas fa-check-circle"></i> {{ annotation.comment }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% endif %}

            <!-- Vocabulary Suggestions -->
            {% if feedback.annotations %}
                {% set vocab_annotations = feedback.annotations | selectattr('type', 'in', ['vocabulary', 'lexical']) | list %}
                {% if vocab_annotations %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-book"></i></div>
                        <h3 class="section-title">Vocabulary Suggestions</h3>
                    </div>
                    {% for annotation in vocab_annotations[:5] %}
                    <div class="vocab-suggestion">
                        <div>
                            <span class="vocab-original">"{{ annotation.text }}"</span>
                            <span class="vocab-arrow"><i class="fas fa-arrow-right"></i></span>
                            <span class="vocab-better">Consider better alternatives</span>
                        </div>
                        <div class="vocab-reason">{{ annotation.comment }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% endif %}

            <!-- Content Accuracy (Integrated Task Only) -->
            {% if task.task_type == 'discussion' %}
                {% if feedback.content_accuracy %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-comments"></i></div>
                        <h3 class="section-title">Thread Alignment</h3>
                    </div>
                    <div class="discussion-context">
                        {{ feedback.content_accuracy }}
                    </div>
                </div>
                {% endif %}

                {% if feedback.point_coverage %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-user-friends"></i></div>
                        <h3 class="section-title">Engagement with Classmates</h3>
                    </div>
                    <ul class="feedback-list">
                        {% for item in feedback.point_coverage %}
                        <li class="feedback-item" style="background: #fefce8; border-left-color: #a855f7;">
                            <div class="feedback-item-icon"><i class="fas fa-quote-right" style="color: #7c3aed;"></i></div>
                            <div class="feedback-item-text">{{ item }}</div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if feedback.example_accuracy %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-lightbulb"></i></div>
                        <h3 class="section-title">New Contribution</h3>
                    </div>
                    <div class="content-note">
                        {{ feedback.example_accuracy }}
                    </div>
                </div>
                {% endif %}

                {% if feedback.paraphrase_quality %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-language"></i></div>
                        <h3 class="section-title">Tone & Academic Style</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 1.25rem; border-radius: 0.5rem; border-left: 4px solid #22c55e; font-size: 1rem; line-height: 1.8; color: var(--toefl-text);">
                        {{ feedback.paraphrase_quality }}
                    </div>
                </div>
                {% endif %}

                {% if feedback.source_integration %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-bullseye"></i></div>
                        <h3 class="section-title">Evidence & Precision</h3>
                    </div>
                    <div class="discussion-context" style="background: #eef2ff; border-color: #c7d2fe;">
                        {{ feedback.source_integration }}
                    </div>
                </div>
                {% endif %}
            {% elif task.task_type == 'integrated' %}
                {% if feedback.content_accuracy %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-bullseye"></i></div>
                        <h3 class="section-title">Content Accuracy</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1.25rem; border-radius: 0.5rem; border-left: 4px solid #f59e0b; font-size: 1rem; line-height: 1.8; color: var(--toefl-text);">
                        {{ feedback.content_accuracy }}
                    </div>
                </div>
                {% endif %}

                {% if feedback.point_coverage %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-list-check"></i></div>
                        <h3 class="section-title">Professor's Points Coverage</h3>
                    </div>
                    <ul class="feedback-list">
                        {% for point in feedback.point_coverage %}
                        <li class="feedback-item" style="background: #fefce8; border-left-color: #eab308;">
                            <div class="feedback-item-icon"><i class="fas fa-circle-check" style="color: #eab308;"></i></div>
                            <div class="feedback-item-text">{{ point }}</div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if feedback.example_accuracy %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-quote-left"></i></div>
                        <h3 class="section-title">Example Usage</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1.25rem; border-radius: 0.5rem; border-left: 4px solid #3b82f6; font-size: 1rem; line-height: 1.8; color: var(--toefl-text);">
                        {{ feedback.example_accuracy }}
                    </div>
                </div>
                {% endif %}

                {% if feedback.source_integration %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-sitemap"></i></div>
                        <h3 class="section-title">Source Integration</h3>
                    </div>
                    <div class="content-note">
                        {{ feedback.source_integration }}
                    </div>
                </div>
                {% endif %}

                {% if feedback.paraphrase_quality %}
                <div class="feedback-section">
                    <div class="section-header">
                        <div class="section-icon"><i class="fas fa-language"></i></div>
                        <h3 class="section-title">Paraphrasing Quality</h3>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 1.25rem; border-radius: 0.5rem; border-left: 4px solid #22c55e; font-size: 1rem; line-height: 1.8; color: var(--toefl-text);">
                        {{ feedback.paraphrase_quality }}
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
// Essay text and annotations data
const essayText = {{ response.essay_text | tojson }};
const annotations = {{ feedback.annotations | tojson }};

// Render essay with annotations
function renderEssayWithAnnotations() {
    const container = document.getElementById('essayContent');

    // Split essay into paragraphs (by double newline or single newline)
    const paragraphs = essayText.split(/\n\n+|\n/).filter(p => p.trim());

    // Sort annotations by start position
    const sortedAnnotations = (annotations || []).sort((a, b) => (a.start || a.start_index || 0) - (b.start || b.start_index || 0));

    let html = '';
    let currentPos = 0;

    // Process each paragraph
    paragraphs.forEach((paragraph, pIndex) => {
        const paragraphStart = essayText.indexOf(paragraph, currentPos);
        const paragraphEnd = paragraphStart + paragraph.length;

        html += '<div class="essay-paragraph">';

        let lastPos = paragraphStart;

        // Find annotations within this paragraph
        sortedAnnotations.forEach((ann, annIndex) => {
            const annStart = ann.start || ann.start_index || 0;
            const annEnd = ann.end || ann.end_index || (annStart + (ann.text || '').length);

            if (annStart >= paragraphStart && annEnd <= paragraphEnd) {
                // Add text before annotation
                if (annStart > lastPos) {
                    html += escapeHtml(essayText.substring(lastPos, annStart));
                }

                // Add annotated text
                html += `<span class="annotation annotation-${ann.type || 'vague'}" data-ann-id="${annIndex}">`;
                html += escapeHtml(ann.text || essayText.substring(annStart, annEnd));
                html += `<span class="annotation-tooltip">${escapeHtml(ann.comment || 'See feedback')}</span>`;
                html += '</span>';

                lastPos = annEnd;
            }
        });

        // Add remaining text in paragraph
        if (lastPos < paragraphEnd) {
            html += escapeHtml(essayText.substring(lastPos, paragraphEnd));
        }

        html += '</div>';
        currentPos = paragraphEnd;
    });

    // If no annotations found or paragraphs missed, render plain text
    if (!html || paragraphs.length === 0) {
        const plainParagraphs = essayText.split(/\n\n+|\n/).filter(p => p.trim());
        html = plainParagraphs.map((p, i) =>
            `<div class="essay-paragraph" style="${i === 0 ? 'text-indent: 0;' : ''}">${escapeHtml(p)}</div>`
        ).join('');
    }

    container.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Revision mode
function enterRevisionMode() {
    document.getElementById('revisionMode').classList.add('active');
    document.getElementById('essayPanel').style.display = 'none';
    updateRevisionWordCount();
}

function exitRevisionMode() {
    document.getElementById('revisionMode').classList.remove('active');
    document.getElementById('essayPanel').style.display = 'block';
}

function updateRevisionWordCount() {
    const text = document.getElementById('revisionEditor').value.trim();
    const words = text ? text.split(/\s+/).length : 0;
    document.getElementById('revisionWordCount').textContent = words;
}

document.getElementById('revisionEditor').addEventListener('input', updateRevisionWordCount);

function submitRevision() {
    const revisedText = document.getElementById('revisionEditor').value.trim();

    if (!revisedText) {
        alert('Please write your revised essay before submitting.');
        return;
    }

    const words = revisedText.split(/\s+/).length;
const minWords = {{ 150 if task.task_type == 'integrated' else 100 if task.task_type == 'discussion' else 200 }};

    if (words < minWords) {
        if (!confirm(`Your revised essay has ${words} words (minimum: ${minWords}). Submit anyway?`)) {
            return;
        }
    }

    const btn = document.getElementById('submitRevisionBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing Revision...';

    fetch('/writing/task/{{ task.id }}/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            essay_text: revisedText,
            is_revision: true,
            parent_response_id: {{ response.id }}
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.redirect) {
            window.location.href = data.redirect;
        } else {
            alert('Failed to submit revision. Please try again.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Revision';
        }
    })
    .catch(err => {
        alert('An error occurred. Please try again.');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Revision';
    });
}

// Initialize
renderEssayWithAnnotations();
</script>
{% endblock %}
